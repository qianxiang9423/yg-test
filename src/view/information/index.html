<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>精准监管，精准监管</title>
    <meta name="viewport">
    
    <meta name="description" content="" />
    <meta name="description" content="" />
    <meta name="baidu-site-verification" content="wczeFssEiy" />
    <!-- <link rel="stylesheet" type="text/css" href="http://www.jq22.com/jquery/bootstrap-3.3.4.css"> -->
    <link rel="stylesheet" href="https://at.alicdn.com/t/c/font_4685771_ffbm2ap0f7b.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/datepicker.css">

</head>

<body pageType='information'>
    <%= require('html-loader!@/components/header/header.ejs')%>
        <div class="container">
            <!-- <div class="header-img">
                <img class="img-logo" src="/images/logo-img.png" />
            </div> -->

            <div class="card" style="margin-top: 100px;">
                <div class="header">
                    <div class="nav">
                        <span class="active">直播</span>
                        <span>点播</span>
                        <span>收视日历</span>
                        <!-- <span>IPTV点播节目融合传播指数</span> -->
                        <!-- <span>实时收视率</span> -->
                        <div class="clear"></div>
                    </div>
                </div>
                <div class="border-content">
                    <div class="content">
                        <div class="box">

                            <!-- 第一个tabs -->
                            <div>
                                <div
                                    style="margin: 0 auto;flex-direction: column;display: flex;align-items: center;justify-content: center;padding-left: 149px;">
                                    <div style="font-weight: bold;font-size: 22px;">中国视听大数据黄金时段电视剧收视情况</div>
                                    <div style="display: flex;margin-top: 10px;margin-left: 40px;">
                                        <select id="year" name="year"></select>
                                        <select id="selectDate" style="margin-left: 20px;"></select>
                                    </div>
                                </div>
                                <div style="display: flex;padding: 0 120px;">
                                    <div class="right">
                                        <div onClick="selectDate()" class="select-container"
                                            style="width: 120px;padding: 10px;margin-bottom: 10px;text-align: center;">
                                            日榜</div>
                                        <div onClick="selectWeek()" class="select-container"
                                            style="width: 120px;padding: 10px;margin-bottom: 10px;text-align: center;">
                                            周榜</div>
                                        <div id="select-menu"></div>
                                    </div>

                                    <div style="flex: 1">
                                        <table cellspacing="0" cellpadding="0" border="0" role="c-table"
                                            data-height="200">
                                            <colgroup id="colId">
                                            </colgroup>
                                            <thead>
                                                <tr id="theadId"></tr>
                                            </thead>
                                            <tbody id="tbodyId">
                                            </tbody>
                                        </table>
                                        <div style="margin-top: 20px;color: #8c8484;">
                                            <div>注：1、黄金时段电视剧指在19:30～21:50内开播的电视剧。</div>
                                            <div style="margin-left: 32px;">2、相关指标为统计周期内有关剧目每集收视指标均值。</div>
                                            <div style="margin-left: 32px;">3、数据发布时间：2024年11月17日。</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 第二个tabs -->
                            <div>
                                <div
                                    style="margin: 0 auto;flex-direction: column;display: flex;align-items: center;justify-content: center;padding-left: 149px;">
                                    <div style="font-weight: bold;font-size: 22px;">IPTV点播融合传媒指数周榜</div>
                                    <div style="display: flex;margin-top: 10px;">
                                        <div class="c-datepicker-date-editor J-datepickerTime-range mt10">
                                            <i class="c-datepicker-range__icon kxiconfont icon-clock"></i>
                                            <input id="startTime" placeholder="开始日期" name=""
                                                class="c-datepicker-data-input" value="">
                                            <span class="c-datepicker-range-separator">-</span>
                                            <input id="endTime" placeholder="结束日期" name=""
                                                class="c-datepicker-data-input" value="">
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex;padding: 0 120px;margin-top: 20px;">
                                    <div class="right">
                                        <!-- <div onClick="selectAll('')" class="select-container"
                                            style="width: 120px;padding: 10px;margin-bottom: 10px;text-align: center;">
                                            全部</div> -->
                                        <div onClick="selectAll('电视剧')" class="select-container"
                                            style="width: 120px;padding: 10px;margin-bottom: 10px;text-align: center;">
                                            电视剧</div>
                                        <div onClick="selectAll('文艺节目')" class="select-container"
                                            style="width: 120px;padding: 10px;margin-bottom: 10px;text-align: center;">
                                            文艺节目</div>
                                        <div id="select-menu"></div>
                                    </div>

                                    <div style="flex: 1">
                                        <table cellspacing="0" cellpadding="0" border="0" role="c-table"
                                            data-height="200">
                                            <colgroup id="topColId">
                                            </colgroup>
                                            <thead>
                                                <tr id="topTheadId"></tr>
                                            </thead>
                                            <tbody id="topTbodyId">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>

                            <!-- 收视日历 -->
                            <div class="tabs-conatiner">
                                <div class="tabs-header">
                                    <div class="tabs-nav">
                                        <!-- <span class="tabs-active">直播</span>
                                        <span>点播</span>
                                        <span>收视日历</span>
                                        <div class="tabs-clear"></div> -->
                                    </div>
                                </div>
                                <div class="tabs-content">
                                    <div class="tabs-box">
                                        <div id="tableEcharts" style="width: 1000px; height: 400px;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- <div style="position: relative;">
                                <div class="title">实时收视率</div>
                                <div style="width:1200px;height: 200px" id="lineChart"></div>

                                <div style="display: flex;justify-content: space-between;margin-top: 40px;">
                                    <div>
                                        <div style="width: 400px;height: 160px" id="lineChart1"></div>
                                    </div>
                                    <div>
                                        <div style="width: 400px;height: 160px" id="lineChart2"></div>
                                    </div>
                                    <div>
                                        <div style="width: 400px;height: 160px" id="lineChart3"></div>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>

            <%= require('html-loader!@/components/qrocde/index.ejs')%>
        </div>

        <%= require('html-loader!@/components/footer/footer.ejs')%>
            <script src="/js/SelectInput.js"></script>
            <script type="text/javascript" src="js/echarts.js"></script>
            <script type="text/javascript" src="js/jquery.combo.select.js"></script>

            <script src="js/moment.min.js"></script>
            <script src="js/datepicker.all.js"></script>
            <script src="js/datepicker.en.js"></script>
            <script type="text/javascript">


            </script>
            <script>
                function initYear(id) {
                    const currentYear = new Date().getFullYear();
                    const startYear = 2024; // 你可以根据需要调整起始年份
                    const selectElement = document.getElementById(id);

                    for (let year = currentYear; year >= startYear; year--) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        selectElement.appendChild(option);
                    }
                    $('#' + id).comboSelect();
                }
                initYear('year');
                initYear('timeYear');
            </script>
            <script>
                $(function () {
                    // var width = 1101; //跟外面盒子的宽度一样，或者写成 
                    var width = $(".content").width();
                    var ulNum = $(".content div").length; //获取ul的个数
                    var contentWidth = width * ulNum; //获取整个box应该的长度，刚开始box设置成了1100，但是应该把所有的ul防到一行里面去，这样box向左移动的时候才是无缝滚动

                    $(".box").width(contentWidth); //给box设置宽度  .width() 是获取宽度  .width(value)是设置宽度
                    $(".box > div").width(width)
                    $(".nav span").click(function () {
                        //$(this)表示点击的这个元素 ，.addClass()表示添加的样式名称，.siblings()表示这个元素的所有兄弟级元素，此处表示span，
                        // .removeClass()表示删除的样式名称
                        $(this).addClass('active').siblings().removeClass('active');

                        var clickNum = $(this).index(); //判断点击的是第几个span .index()方法返回第几个，从0开始算起
                        //alert(clickNum);

                        var moveLeft = clickNum * width * -1; //应该向左移动的距离

                        $(".box").animate({ 'margin-left': moveLeft }, 600);  //通过操作box的left来使box向左移动， .animate 是动画函数
                        //第一个参数用{}包含起来，里面的内容形式为 {'left':100,'top':100}，多个用逗号隔开，
                        // 表示从当前位置移动到left为100px、top为100px的位置（即left:100px;top:100px处），
                        //第二个参数为时间，表示从当前位置移动到第一个参数用时，单位为ms，1000ms=1秒
                        //点击的时候一定要点开审查元素，查看box元素的行内样式
                    })

                })
            </script>

            <script>

                function getCalenderDate(label) {
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/viewing_calendar/detailList',
                        method: "get",
                        data: {
                            name: label,
                            pageSize: 10
                        },
                        success: function (result) {
                            $(".table-wrap").hide()
                            $("#tableEcharts").show()

                            let xData = []
                            let yData = []

                            result.rows.forEach((item, index) => {
                                let rate = Number(item.audienceRating.replace('%', ''))
                                xData.push(item.remark)
                                yData.push(rate)
                            })
                            var myTableChart = echarts.init(document.getElementById('tableEcharts'));
                            // 指定图表的配置项和数据
                            var option = {
                                title: {
                                    text: label
                                },
                                tooltip: {
                                    trigger: 'axis',
                                    axisPointer: {
                                        type: 'shadow'
                                    }
                                },
                                grid: {
                                    left: '3%',
                                    right: '4%',
                                    bottom: '3%',
                                    containLabel: true
                                },
                                xAxis: [
                                    {
                                        name: '日期',
                                        type: 'category',
                                        data: xData,
                                        axisTick: {
                                            alignWithLabel: true
                                        }
                                    }
                                ],
                                yAxis: [
                                    {
                                        name: '收视率（%）',
                                        type: 'value',
                                        axisLine: {
                                            show: true // 确保这个属性是true
                                        },
                                    }
                                ],
                                series: [
                                    {
                                        name: '收视率',
                                        // type: 'bar',
                                        type: 'line',
                                        itemStyle: {
                                            color: new echarts.graphic.LinearGradient(
                                                0, 0, 0, 1,
                                                [
                                                    { offset: 0, color: '#fcc05b' },
                                                    { offset: 1, color: '#f50000' }
                                                ]
                                            )
                                        },
                                        barGap: '0%',
                                        barWidth: 15,
                                        data: yData
                                    }
                                ]
                            };

                            // 使用刚指定的配置项和数据显示图表。
                            myTableChart.setOption(option);
                        }
                    });
                }
                $(function () {
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/viewing_calendar/list',
                        method: "get",
                        success: function (result) {
                            let menuOptions = result.rows.map((item) => {
                                return {
                                    // label: item.channelType2,
                                    value: item.id,
                                    label: item.title
                                }
                            })
                            $(".tabs-nav").empty()
                            menuOptions.forEach((item, index) => {
                                if (index == 0) {
                                    $(".tabs-nav tabs-active").append('<span>' + item.label + '</span>')
                                } else {
                                    $(".tabs-nav").append('<span>' + item.label + '</span>')
                                }
                            })
                            getCalenderDate(menuOptions[0].label)

                            var width = $(".tabs-content").width();
                            var ulNum = $(".tabs-content div").length; //获取ul的个数
                            var contentWidth = width * ulNum; //获取整个box应该的长度，刚开始box设置成了1100，但是应该把所有的ul防到一行里面去，这样box向左移动的时候才是无缝滚动

                            $(".tabs-box").width(contentWidth); //给box设置宽度  .width() 是获取宽度  .width(value)是设置宽度
                            $(".tabs-box > div").width(width)
                            $(".tabs-nav span").click(function () {
                                //$(this)表示点击的这个元素 ，.addClass()表示添加的样式名称，.siblings()表示这个元素的所有兄弟级元素，此处表示span，
                                // .removeClass()表示删除的样式名称
                                $(this).addClass('tabs-active').siblings().removeClass('tabs-active');

                                var clickNum = $(this).index(); //判断点击的是第几个span .index()方法返回第几个，从0开始算起
                                //alert(clickNum);

                                let text = $(this).text()
                                getCalenderDate(text)
                                // var moveLeft = clickNum * width * -1; //应该向左移动的距离

                                // $(".tabs-box").animate({ 'left': moveLeft }, 600);
                                // getCalenderDate(selectedValue.label)
                            })
                        }
                    });
                })
            </script>

            <script>
                columns = [
                    {
                        label: "剧名",
                        width: 100,
                        column: "name"
                    },
                    {
                        label: "播出集数",
                        width: 60,
                        column: "episode"
                    },
                    {
                        label: "收视率",
                        width: 60,
                        column: "audienceRating"
                    },
                    {
                        label: "收视份额",
                        width: 60,
                        column: "ratingShare"
                    },
                    {
                        label: "播出频道",
                        width: 60,
                        column: "channel"
                    },
                ]

                let menuColumns = [
                    {
                        label: "剧名",
                        width: 100,
                        column: "name"
                    },
                    {
                        label: "播出集数",
                        width: 60,
                        column: "episode"
                    },
                    {
                        label: "收视率",
                        width: 60,
                        column: "audienceRating"
                    },
                    {
                        label: "收视份额",
                        width: 60,
                        column: "ratingShare"
                    },
                    {
                        label: "节目类型",
                        width: 60,
                        column: "note"
                    },
                    {
                        label: "播出频道",
                        width: 60,
                        column: "channel"
                    },
                ]

                function renderColumn(columns) {
                    $('#theadId').empty()
                    $.each(columns, function (index, item) {
                        let $colgroup = $('<col name="">')
                        $('#colId').append($colgroup);

                        let $thead = $('<th class=""><div class="cell">' + item.label + '</div></th>')
                        $('#theadId').append($thead);
                    })
                }

                renderColumn(columns)

                function handleTableData(list) {
                    let headData = columns
                    if (selectType == "季度榜") {
                        renderColumn(menuColumns)
                        headData = menuColumns
                    } else {
                        renderColumn(columns)
                    }
                    $('#tbodyId').empty()
                    list.rows.forEach((item, index) => {
                        let $tr = null
                        if (index % 2 == 0) {
                            $tr = $('<tr></tr>')
                        } else {
                            $tr = $('<tr class="trip"></tr>')
                        }

                        headData.forEach((col) => {
                            let $td = $('<td class=""><div class="cell">' + item[col.column] + '</div></td>')
                            $tr.append($td);
                        })
                        $('#tbodyId').append($tr);
                    })
                }
            </script>

            <script>
                var selectType = ""
                let tvOptions = [
                    {
                        label: "电视剧",
                        value: 1
                    },
                    {
                        label: "文艺节目",
                        value: 2
                    },
                    {
                        label: "电视剧",
                        value: 3
                    },
                    {
                        label: "文艺节目",
                        value: 4
                    }
                ]

                function selectDate() {
                    // 日榜数据
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/dayrankings/datelist',
                        success: function (result) {
                            let dateList = result.rows.map((item) => {
                                return {
                                    label: item
                                }
                            })
                            const selectElement = document.getElementById('selectDate');
                            $("#selectDate").empty()
                            dateList.forEach((item, index) => {
                                const option = document.createElement('option');
                                option.value = item.label;
                                option.textContent = item.label;
                                selectElement.appendChild(option);
                            })
                            $('#selectDate').comboSelect();
                            selectType = "日榜"
                            getDateMenu(dateList[0].label)
                        }
                    });
                }

                selectDate()

                function selectWeek() {
                    // 周榜数据
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/weekrankings/datelist',
                        method: "get",
                        data: {
                            pageSize: 10
                        },
                        success: function (result) {
                            let dateList = result.rows.map((item) => {
                                return {
                                    label: Object.values(item),
                                    value: Object.keys(item)
                                }
                            })

                            const selectElement = document.getElementById('selectDate');
                            $("#selectDate").empty()
                            dateList.forEach((item, index) => {
                                const option = document.createElement('option');
                                option.value = item.value;
                                option.textContent = item.label;
                                selectElement.appendChild(option);
                            })
                            $('#selectDate').comboSelect();
                            selectType = "周榜"
                            getWeekMenu(dateList[0].value)
                        }
                    });
                }

                function selectQuarter(type) {
                    // 季度榜数据
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/quarterlyrankings/quarterly_date_list',
                        method: "get",
                        data: {
                            pageSize: 10
                        },
                        success: function (result) {
                            let dateList = Object.keys(result.rows[currentYear]).map((item) => {
                                return {
                                    label: item,
                                    value: result.rows[currentYear][item]
                                }
                            })

                            const selectElement = document.getElementById('selectDate');
                            $("#selectDate").empty()
                            dateList.forEach((item, index) => {
                                const option = document.createElement('option');
                                option.value = item.value;
                                option.textContent = item.label;
                                selectElement.appendChild(option);
                            })
                            $('#selectDate').comboSelect();
                            selectType = "季度榜"
                            quarterType = type
                            getQuarterMenu(dateList[0].value)
                        }
                    });
                }



                // 日榜单
                function getDateMenu(selectedValue) {
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/dayrankings/list',
                        method: "get",
                        data: {
                            // note: "电视剧",
                            date: selectedValue,
                            pageSize: 10
                        },
                        success: function (result) {
                            handleTableData(result)
                        }
                    });
                }

                // 获取周榜数据
                function getWeekMenu(selectedValue) {
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/weekrankings/list',
                        method: "get",
                        data: {
                            // note: "电视剧",
                            date: selectedValue,
                            pageSize: 10,
                        },
                        success: function (result) {
                            handleTableData(result)
                        }
                    });
                }

                function getQuarterMenu(date) {
                    console.log(quarterType, "quarterType")
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/quarterlyrankings/list',
                        method: "get",
                        data: {
                            // pageSize: 10,
                            type: quarterType,
                            date,
                        },
                        success: function (result) {
                            handleTableData(result)
                        }
                    });
                }

                let selectMenu = new SelectInput('#select-menu', '季度榜', tvOptions);

                $('select').change(function (e, v) {
                    if ($(e.target).attr("id") == "year") {
                        if (selectType == "日榜") {
                            selectDate(e.target.value)
                        } else if (selectType == "周榜") {
                            selectWeek(e.target.value)
                        } else if (selectType == "季度榜") {
                            selectQuarter(e.target.value)
                        }
                        return
                    }
                    console.log(e.target.value, "e.target.value")
                    if (selectType == "日榜") {
                        getDateMenu(e.target.value)
                    } else if (selectType == "周榜") {
                        getWeekMenu(e.target.value)
                    } else if (selectType == "季度榜") {
                        getQuarterMenu(e.target.value)
                    }
                });

                $(document).on('change', '#select-menu', function (event, selectedValue) {
                    selectQuarter(selectedValue.value)
                });

                function channel(type) {
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/quarterlyrankings/list',
                        method: 'GET',
                        async: false,
                        data: {
                            type: type
                        },
                        success: function (result) {
                            handleTableData(result)
                        }
                    });
                }
            </script>

            <script>
                function selectAll(type) {
                    type = type;
                    getIptvData(type, startDate, endDate)
                }
                var type = "电视剧";
                var startDate = "";
                var endDate = "";

                let iptvColumns = [
                    {
                        label: "排序",
                        width: 200,
                        column: "sort"
                    },
                    {
                        label: "剧名",
                        width: 400,
                        column: "title"
                    },
                    {
                        label: "类型",
                        width: 500,
                        column: "type"
                    },
                    {
                        label: "收视率",
                        width: 200,
                        column: "rate"
                    },
                ]

                $.each(iptvColumns, function (index, item) {
                    let $colgroup = $('<col name="" width="' + item.width + '">')
                    $('#topColId').append($colgroup);

                    let $thead = $('<th class=""><div class="cell">' + item.label + '</div></th>')
                    $('#topTheadId').append($thead);
                })

                $(function () {
                    var DATAPICKERAPI = {
                        // 默认input显示当前月,自己获取后填充
                        activeMonthRange: function () {
                            return {
                                begin: moment().set({ 'month': 3, 'hour': 0, 'minute': 0, 'second': 0 }).format('YYYY-MM-DD'),
                                end: moment().set({ 'hour': 23, 'minute': 59, 'second': 59 }).format('YYYY-MM-DD')
                            }
                        },
                    };
                    //十分年月日范围
                    $('.J-datepickerTime-range').datePicker({
                        format: 'YYYY-MM-DD',
                        isRange: true,
                        hide: function () {
                            startDate = this.$input.eq(0).val()
                            endDate = this.$input.eq(1).val()
                            getIptvData(type, startDate, endDate)
                            // console.info(this.$input.eq(0).val(), this.$input.eq(1).val());
                        }
                    });

                    function init() {
                        startDate = DATAPICKERAPI.activeMonthRange().begin;
                        endDate = DATAPICKERAPI.activeMonthRange().end;
                        $("#startTime").val(startDate);
                        $("#endTime").val(endDate);
                        getIptvData(type, startDate, endDate)
                    }

                    init();
                });


                function getIptvData(type, startDate, endDate) {
                    $.ajax({
                        url: 'http://196.10.20.222:8081/prod-api/iptv/list',
                        async: false,
                        data: {
                            startDate: startDate,
                            endDate: endDate,
                            type: type
                        },
                        timeout: 5000,  //超时时间设置
                        success: function (result) {
                            $('#topTbodyId').empty()
                            result.rows.forEach((item, index) => {
                                let $tr = null
                                if (index % 2 == 0) {
                                    $tr = $('<tr></tr>')
                                } else {
                                    $tr = $('<tr class="trip"></tr>')
                                }
                                iptvColumns.forEach(key => {
                                    $.each(item, function (columnItem) {
                                        if (key.column == columnItem) {
                                            let $td = $('<td style="height: 40px!important"><div class="cell">' + item[columnItem] + '</div></td>')
                                            $tr.append($td);
                                        }
                                    })
                                })
                                $('#topTbodyId').append($tr);
                            })
                        }
                    });
                }
            </script>
</body>

</html>